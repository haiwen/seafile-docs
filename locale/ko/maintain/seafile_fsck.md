# Seafile FSCK

Seafile 서버 측에서는 자체 형식으로 라이브러리에 파일을 저장합니다. Seafile에는 각각에 자체 디렉터리와 파일 형상을 지니고 있습니다(git와 유사).

기본 설치 후, 자체 객체는 서버 파일 시스템(ext4, NTFS)에 바로 저장합니다. 허나 대부분의 파일 시스템은 갑작스러운 전원 꺼짐 또는 시스템 손상시 파일 내용의 무결성을 보증할 수 없습니다. 따라서 시스템 손상시 Seafile 자체 객체를 기록했다면, 시스템을 다시 부팅했을 때 객체가 깨질 수 있습니다. 이렇게 되면 각각의 라이브러리의 일부에 접근할 수 없습니다.

참고: 배터리 보조 NAS(EMC 또는 NetApp)에 seafile-data 디렉터리를 저장하거나, 전문가판의 S3 백엔드를 사용한다면 자체 객체는 깨지지 않습니다.

Seafile 버전 2.0 부터는 Seafile 서버에 seaf-fsck 도구(git-fsck 도구와 유사)를 도입하여 깨진 데이터 복구를 도와줍니다. 이 도구는 어떤 깨진 라이브러리도 최근의 일관성을 유지하고 안정적으로 사용할 수 있도록 복구합니다.

Seafile 버전 4.1 부터는 seaf-fsck.sh 스크립트를 제공합니다. seaf-fsck 도구는 다음 인자를 받아들입니다:

```
cd seafile-server-latest
./seaf-fsck.sh [--repair|-r] [--enable-sync|-e] [--export|-E export_path] [repo_id_1 [repo_id_2 ...]]
```

seaf-fsck 동작 방식은 세가지가 있습니다:

1.  라이브러리 무결성을 검사합니다.
2. 깨진 라이브러리를 복구합니다.
3. 라이브러리를 내보냅니다.

## 라이브러리 무결성 검사

어떤 인자도 붙이지 않고 seaf-fsck.sh를 실행하면 모든 라이브러리에 대해 **읽기 전용** 상태로 무결성을 검사합니다.

```
cd seafile-server-latest
./seaf-fsck.sh
```

일부 라이브러리의 무결성을 검사하려면 라이브러리 ID를 인자로 붙이십시오:

```
cd seafile-server-latest
./seaf-fsck.sh [library-id1] [library-id2] ...
```

출력 결과는 다음과 같습니다:

```
[02/13/15 16:21:07] fsck.c(470): Running fsck for repo ca1a860d-e1c1-4a52-8123-0bf9def8697f.
[02/13/15 16:21:07] fsck.c(413): Checking file system integrity of repo fsck(ca1a860d)...
[02/13/15 16:21:07] fsck.c(35): Dir 9c09d937397b51e1283d68ee7590cd9ce01fe4c9 is missing.
[02/13/15 16:21:07] fsck.c(200): Dir /bf/pk/(9c09d937) is curropted.
[02/13/15 16:21:07] fsck.c(105): Block 36e3dd8757edeb97758b3b4d8530a4a8a045d3cb is corrupted.
[02/13/15 16:21:07] fsck.c(178): File /bf/02.1.md(ef37e350) is curropted.
[02/13/15 16:21:07] fsck.c(85): Block 650fb22495b0b199cff0f1e1ebf036e548fcb95a is missing.
[02/13/15 16:21:07] fsck.c(178): File /01.2.md(4a73621f) is curropted.
[02/13/15 16:21:07] fsck.c(514): Fsck finished for repo ca1a860d.
```

깨진 파일과 디렉터리가 나타납니다.

때로는 다음과 같은 출력 내용을 볼 수 있습니다:

```
[02/13/15 16:36:11] Commit 6259251e2b0dd9a8e99925ae6199cbf4c134ec10 is missing
[02/13/15 16:36:11] fsck.c(476): Repo ca1a860d HEAD commit is corrupted, need to restore to an old version.
[02/13/15 16:36:11] fsck.c(314): Scanning available commits...
[02/13/15 16:36:11] fsck.c(376): Find available commit 1b26b13c(created at 2015-02-13 16:10:21) for repo ca1a860d.
```

데이터베이스에 기록한 "가장 최근의 커밋"(라이브러리 현재 상태)이 라이브러리 데이터와 일치하지 않음을 나타냅니다. 이 경우, fsck에서 최근 일관성 확보 상태를 찾아 해당 상태의 무결성을 확인합니다.

요령: **라이브러리가 많다면, 추후 분석 용도로 로그 파일에 출력 내용을 저장하는 것이 좋습니다.**

## 손상 복구

seaf-fsck의 손상 복구 기능은 기본적으로 두 단계에 걸쳐 동작합니다:

1. 데이터베이스에 기록한 라이브러리 상태(커밋)을 데이터 디렉터리에서 찾을 수 없으면 데이터 디렉터리에서 최근의 상태를 확인합니다.
2. 각각의 상태에 대해 데이터 무결성을 확인합니다. 파일 또는 디렉터리가 깨졌다면 빈 파일 또는 빈 디렉터리로 설정합니다. 깨진 경로는 보고하여 사용자가 다른 어떤 방편으로든 복구할 수 있게 합니다.

다음 명령을 실행하면 모든 라이브러리를 복구합니다:

```
cd seafile-server-latest
./seaf-fsck.sh --repair
```

대부분 읽기 전용 방식으로 무결성 검사를 먼저 실행하여 어떤 라이브러리가 깨졌는지 확인합니다. 그리고 각각의 라이브러리를 다음 명령으로 복구합니다:

```
cd seafile-server-latest
./seaf-fsck.sh --repair [library-id1] [library-id2] ...
```

손상된 파일 및 디렉터리는 복구 후 비워둔 상태가 되기 때문에, 복구 과정이 끝나고 라이브러리를 동기화하면 클라이언트의 데이터를 잃을 수 있습니다. 클라이언트의 제대로 된 사본을 빈 사본으로 바꿉니다. 이 문제를 막으려, 시스템에서는 클라이언트와의 동기화로 라이브러리의 "복구"를 막습니다. 시스템 관리자는 사용자에게 손상 파일과 폴더를 복구하라고 알려야합니다. 그리고 다음 명령을 실행하여 라이브러리 동기화를 다시금 활성화하십시오:

```
cd seafile-server-latest
./seaf-fsck.sh --enable-sync [library-id1] [library-id2] ...
```

### 커뮤니티판 5.0.3 및 전문가판 5.0.2 이후 버전에서 바뀐 사항

커뮤니티판 5.0.3 및 전문가판 5.0.2부터 seaf-fsck 복구 동작을 개선했습니다. 개선사항 두가지를 추가했습니다:

- "--repair" 동작 실행 후, 시스템 관리자는 더 이상 "--enable-sync" 명령을 실행하지 않아도 됩니다. 대신, seaf-fsck에서 자동으로 라이브러리에 연결한 모든 클라이언트 연결을 끊습니다. 따라서 사용자는 라이브러리를 강제로 다시 동기화 해야합니다.
- 라이브러리 기록에서, seaf-fsck 결과에는 손상된 파일 및 폴더가 들어갑니다. 따라서 손상된 경로를 쉽게 찾을 수 있습니다.

### 라이브러리 복구 사례

모든 라이브러리를 검사하여 어떤 라이브러리가 손상되었는지 찾으려면, 시스템 관리자가 어떤 인자도 설정하지 않은 상태에서 seaf-fsck.sh를 실행한 후 로그 파일에 출력 내용을 저장할 수 있습니다. 손상된 라이브러리를 찾으려면 로그 파일에서 "Fail" 키워드를 찾으십시오.

시스템 관리자가 손상된 라이브러리를 찾으면, 라이브러리를 복구하는 "--repair" 인자를 주어 seaf-fsck.sh를 실행하십시오. 명령 실행으로 라이브러리 문제를 수정하면, 관리자는 다른 위치의 파일로 라이브러리의 파일을 복구하라고 알려주어야합니다. 두가지 방법이 있습니다:

- 웹 인터페이스로 깨진 파일 또는 폴더를 업로드
- 임의의 데스크톱 컴퓨터에서 라이브러리를 동기화했고, 컴퓨터에 손상된 파일의 올바른 버전이 있다면, 해당 컴퓨터의 라이브러리를 다시 동기화할 때 서버에서 손상된 파일을 업로드합니다.

## 라이브러리를 파일 시스템으로 내보내기

버전 4.2.0 부터, seaf-fsck 명령으로 라이브러리의 모든 파일을 외부 파일 시스템(ext4 등)으로 내보낼 수 있습니다. 이 절차는 Seafile 데이터베이스 상태에 의존하지 않습니다. seafile-data 디렉터리를 보유하는 동안 Seafile의 파일을 외부 파일 시스템으로 언제든 내보낼 수 있습니다.

명령 문법은 다음과 같습니다

```
cd seafile-server-latest
./seaf-fsck.sh --export top_export_path [library-id1] [library-id2] ...
```

`top_export_path` 인자는 내보낸 파일이 들어가는 디렉터리입니다. 각 라이브러리는 내보내기 경로의 하위 디렉터리 형태로 내보냅니다. 라이브러리 ID를 지정하지 않으면 모든 라이브러리를 내보냅니다.

현재 암호화하지 않은 라이브러리만 내보낼 수 있습니다. 암호화 한 라이브러리는 건너뜁니다.

